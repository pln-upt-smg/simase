name: Laravel

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Install Github Action Checkout
        uses: actions/checkout@v2

      - name: ğŸ“¥ Install PHP v8.0 and Composer v2
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.0"

      - name: ğŸ“¥ Install NodeJS and NPM
        uses: bahmutov/npm-install@v1

      - name: ğŸ”» Shutdown Default Ubuntu MySQL Service
        run: sudo service mysql stop

      - name: âš™ï¸ Set up new MySQL Service and Create MySQL Database
        uses: mirromutth/mysql-action@v1.1
        with:
          host port: "3306"
          mysql version: "5.7"
          mysql root password: "simase"
          mysql database: "simase"

      - name: âš™ï¸ Set up Application Environment Variables for CI/CD (Development)
        run: |
          php -r "file_exists('.env') || copy('.env.example', '.env');"
          sed -i 's/localhost/127.0.0.1/' .env
          sed -i 's/APP_ENV=local/APP_ENV=production/' .env
          sed -i 's/APP_ENV_CI_CD=false/APP_ENV_CI_CD=true/' .env
          sed -i 's/APP_DEBUG=true/APP_DEBUG=false/' .env
          sed -i 's/DB_USERNAME=simase/DB_USERNAME=root/' .env

      - name: ğŸš¨ Set Application Directory Permissions
        run: |
          sudo chmod -R ug+rwx storage bootstrap/cache
          sudo chmod -R g+w storage/logs

      - name: ğŸ“¦ Install Composer Dependencies
        uses: ramsey/composer-install@v1

      - name: ğŸ“¦ Install NPM Dependencies
        run: npm ci

      - name: ğŸ”‘ Generate Application Key
        run: php artisan key:generate

      - name: ğŸ’¾ Link Application Storage
        run: php artisan storage:link

      - name: ğŸ—„ï¸ Run Database Migration
        run: php artisan migrate --force

      - name: ğŸ”„ Verify Database Rollback
        run: php artisan migrate:refresh --force

      - name: ğŸ—ƒï¸ Run Database Seeder
        run: php artisan db:seed --force

      - name: ğŸ—‘ï¸ Clear Laravel Cache
        run: sudo php artisan optimize:clear

      - name: ğŸ¨ Run Laravel Mix for Production
        run: npm run production

      - name: ğŸ”§ Optimize Laravel Configuration
        run: |
          php artisan optimize
          php artisan view:cache

      - name: ğŸ§ª Run Application Linter (Static Code Analyzer) via PHPStan
        run: composer lint
